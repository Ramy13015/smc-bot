//@version=5
indicator("SMC Detector - HIGH VOLUME MARKETS", shorttitle="SMC-HV", overlay=true)

// === CONFIGURATION HIGH VOLUME ===
symbol_select = input.string("BTCUSDT.P", "High Volume Symbol", options=["EURUSD", "GBPUSD", "USDJPY", "AUDUSD", "USDCAD", "XAUUSD", "BTCUSDT.P", "ETHUSDT.P", "SOLUSDT.P", "ADAUSDT.P", "DOGEUSDT.P", "XRPUSDT.P"])
htf_tf = input.timeframe("5", "Timeframe", options=["1", "5", "15", "60"])
webhook_url = input.string("https://smc-gal.onrender.com/tv", "Webhook URL")

// Volume filter for high-activity markets only
min_volume_mult = input.float(1.5, "Minimum Volume Multiplier", minval=1.0, maxval=5.0)

// === SYMBOL LOGIC ===
get_symbol_data() =>
    asset_type = "forex"
    if str.contains(symbol_select, ".P") or str.contains(symbol_select, "USDT")
        asset_type := "crypto"
    else if str.contains(symbol_select, "XAU")
        asset_type := "gold"
    
    [request.security(symbol_select, timeframe.period, close), asset_type]

[current_price, asset_type] = get_symbol_data()

// === HIGH VOLUME FILTER ===
volume_sma = ta.sma(volume, 20)
high_volume = volume > volume_sma * 1.0  // TEST: Lowered from 1.5x to 1.0x for more signals

// === SMC DETECTION ENHANCED ===
// ATR calculation with asset-specific adjustments
atr_length = 14
atr_value = ta.atr(atr_length)

// Volume-weighted ATR for better accuracy
vol_weighted_atr = atr_value * (volume / volume_sma)

// POI (Point of Interest) detection - Enhanced for high volume
rsi_value = ta.rsi(close, 14)
poi_valid = (ta.crossover(rsi_value, 30) or ta.crossunder(rsi_value, 70))  // TEST: Removed high_volume requirement

// FVG (Fair Value Gap) detection - More strict for perpetuals
fvg_threshold = asset_type == "crypto" ? 0.5 : 0.3  // TEST: Lowered from 0.8/0.5 to 0.5/0.3
fvg_gap = math.abs(high[1] - low[1]) > atr_value * fvg_threshold
fvg_open = fvg_gap and (close > high[1] or close < low[1])  // TEST: Removed high_volume requirement

// Order Block detection - Volume confirmation required
ob_volume_threshold = asset_type == "crypto" ? 2.0 : 1.5
ob_volume = volume > ta.sma(volume, 20) * ob_volume_threshold
ema_cross = ta.crossover(close, ta.ema(close, 20)) or ta.crossunder(close, ta.ema(close, 20))
ob_valid = ob_volume and ema_cross

// BOS (Break of Structure) - Enhanced for volatile markets
swing_length = asset_type == "crypto" ? 7 : 5
swing_high = ta.pivothigh(high, swing_length, swing_length)
swing_low = ta.pivotlow(low, swing_length, swing_length)
bos_detected = not na(swing_high) or not na(swing_low)
bos_confirm = bos_detected and high_volume

// CHOCH (Change of Character) - Trend reversal detection
ema_fast = ta.ema(close, 21)
ema_slow = ta.ema(close, 50)
trend_direction = ema_fast > ema_slow ? 1 : -1
choch_confirm = trend_direction != trend_direction[1] and high_volume

// Additional SMC flags for high volume markets
liq_swept = volume > ta.sma(volume, 10) * 2.5 and high_volume
imbalance_threshold = asset_type == "crypto" ? 1.2 : 0.8
imbalance_filled = math.abs(close - open) > atr_value * imbalance_threshold

// Trend alignment - Multiple timeframes
ema_200 = ta.ema(close, 200)
trend_aligned = (close > ema_fast and ema_fast > ema_slow and ema_slow > ema_200) or (close < ema_fast and ema_fast < ema_slow and ema_slow < ema_200)

volume_confirm = volume > ta.sma(volume, 20) * 1.3

// Time filter - Avoid low liquidity hours (enhanced for crypto)
is_crypto = asset_type == "crypto"
avoid_hours = is_crypto ? false : (hour >= 22 or hour <= 2)
time_filter = not avoid_hours and high_volume

// === SIGNAL GENERATION FOR HIGH VOLUME ===
// TEST MODE: Relaxed conditions to verify connection
// Original: poi_valid and fvg_open and trend_aligned and volume_confirm
long_signal_strength = (poi_valid or fvg_open) and high_volume  // Just need ONE of POI or FVG
short_signal_strength = (poi_valid or fvg_open) and high_volume

long_condition = long_signal_strength and close > ema_fast
short_condition = short_signal_strength and close < ema_fast

// === WEBHOOK PAYLOAD ===
if (long_condition or short_condition) and high_volume
    direction = long_condition ? "LONG" : "SHORT"
    event_id = str.tostring(symbol_select) + "_HV_" + str.tostring(time) + "_" + str.tostring(math.round(math.random()*10000))
    
    // Use volume-weighted ATR for crypto perpetuals
    final_atr = asset_type == "crypto" ? vol_weighted_atr : atr_value
    
    // Dynamic timeframe in payload
    tf_display = htf_tf == "1" ? "1min" : htf_tf == "5" ? "5min" : htf_tf == "15" ? "15min" : "1h"
    
    // Simplified payload construction
    payload = '{"event_id":"' + event_id + '","symbol":"' + symbol_select + '","timeframe":"' + tf_display + '","direction":"' + direction + '","price_ctx":{"entry":' + str.tostring(close) + ',"ref_high":' + str.tostring(high) + ',"ref_low":' + str.tostring(low) + '},"atr":' + str.tostring(final_atr) + ',"asset_type":"' + asset_type + '","flags":{"poi_valid":' + str.tostring(poi_valid) + ',"fvg_open":' + str.tostring(fvg_open) + ',"ob_valid":' + str.tostring(ob_valid) + ',"bos_confirm":' + str.tostring(bos_confirm) + ',"choch_confirm":' + str.tostring(choch_confirm) + ',"liq_swept":' + str.tostring(liq_swept) + ',"imbalance_filled":' + str.tostring(imbalance_filled) + ',"trend_aligned":' + str.tostring(trend_aligned) + ',"volume_confirm":' + str.tostring(volume_confirm) + ',"time_filter":' + str.tostring(time_filter) + '}}'
    
    alert(payload, alert.freq_once_per_bar)

// === ðŸŽ¨ PROFESSIONAL UI - CLEAN & MINIMAL ===

// 1ï¸âƒ£ SINGLE ARROW PER SIGNAL (no clutter)
plotshape(long_condition and high_volume, style=shape.triangleup, location=location.belowbar, 
          color=color.new(color.lime, 0), size=size.huge, title="LONG", text="ðŸ”¼")
plotshape(short_condition and high_volume, style=shape.triangledown, location=location.abovebar, 
          color=color.new(color.red, 0), size=size.huge, title="SHORT", text="ðŸ”½")

// 2ï¸âƒ£ FVG BOXES (Fair Value Gap) - 90% transparent
var box fvg_box = na
if fvg_open
    fvg_top = math.max(high[1], close)
    fvg_bottom = math.min(low[1], close)
    box.delete(fvg_box[1])
    fvg_box := box.new(bar_index - 1, fvg_top, bar_index + 5, fvg_bottom, 
                       border_color=color.new(color.yellow, 50), 
                       bgcolor=color.new(color.yellow, 90),
                       border_width=1)

// 3ï¸âƒ£ ORDER BLOCK BOXES - 85% transparent
var box ob_box = na
if ob_valid
    ob_top = high
    ob_bottom = low
    box.delete(ob_box[1])
    ob_box := box.new(bar_index, ob_top, bar_index + 10, ob_bottom,
                      border_color=color.new(color.blue, 50),
                      bgcolor=color.new(color.blue, 85),
                      border_width=2)

// 4ï¸âƒ£ FIBONACCI LEVELS (50%, 61.8%, 78.6%)
var line fib_50 = na
var line fib_618 = na
var line fib_786 = na
if long_condition or short_condition
    swing_range = high - low
    fib_50_level = low + swing_range * 0.5
    fib_618_level = low + swing_range * 0.618
    fib_786_level = low + swing_range * 0.786
    
    line.delete(fib_50[1])
    line.delete(fib_618[1])
    line.delete(fib_786[1])
    
    fib_50 := line.new(x1=bar_index, y1=fib_50_level, x2=bar_index + 20, y2=fib_50_level, color=color.new(color.gray, 60), width=1, style=line.style_dashed)
    fib_618 := line.new(x1=bar_index, y1=fib_618_level, x2=bar_index + 20, y2=fib_618_level, color=color.new(color.orange, 60), width=1, style=line.style_dashed)
    fib_786 := line.new(x1=bar_index, y1=fib_786_level, x2=bar_index + 20, y2=fib_786_level, color=color.new(color.red, 60), width=1, style=line.style_dashed)

// 5ï¸âƒ£ EMAs - Subtle lines
plot(ema_fast, "EMA 21", color=color.new(color.aqua, 70), linewidth=1)
plot(ema_slow, "EMA 50", color=color.new(color.orange, 70), linewidth=1)
plot(ema_200, "EMA 200", color=color.new(color.white, 80), linewidth=2)

// 6ï¸âƒ£ STATUS LABEL - Fixed top right
var label status_label = na
if barstate.islast
    label.delete(status_label)
    status_text = symbol_select + " | " + asset_type + " | " + htf_tf + "min"
    status_color = high_volume ? color.new(color.green, 10) : color.new(color.gray, 10)
    status_label := label.new(bar_index, high, status_text, 
                              style=label.style_label_left, 
                              color=status_color, 
                              textcolor=color.white, 
                              size=size.normal,
                              yloc=yloc.price)

// 7ï¸âƒ£ STATS TABLE - Bottom right (4 rows)
var table stats_table = table.new(position.bottom_right, 2, 4, 
                                   bgcolor=color.new(color.black, 20), 
                                   border_color=color.new(color.gray, 50),
                                   border_width=1)
if barstate.islast
    // Row 1: Volume Status
    table.cell(stats_table, 0, 0, "Volume", text_color=color.gray, text_size=size.small, bgcolor=color.new(color.black, 30))
    vol_status = high_volume ? "HIGH âœ…" : "LOW âš ï¸"
    vol_color = high_volume ? color.lime : color.orange
    table.cell(stats_table, 1, 0, vol_status, text_color=vol_color, text_size=size.small, bgcolor=color.new(color.black, 30))
    
    // Row 2: ATR
    table.cell(stats_table, 0, 1, "ATR", text_color=color.gray, text_size=size.small, bgcolor=color.new(color.black, 30))
    atr_display = str.tostring(math.round(atr_value, 2))
    table.cell(stats_table, 1, 1, atr_display, text_color=color.white, text_size=size.small, bgcolor=color.new(color.black, 30))
    
    // Row 3: Signals Today
    table.cell(stats_table, 0, 2, "Signals", text_color=color.gray, text_size=size.small, bgcolor=color.new(color.black, 30))
    signal_count = ta.cum(long_condition or short_condition ? 1 : 0)
    table.cell(stats_table, 1, 2, str.tostring(signal_count), text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.black, 30))
    
    // Row 4: Last Signal
    table.cell(stats_table, 0, 3, "Last", text_color=color.gray, text_size=size.small, bgcolor=color.new(color.black, 30))
    last_signal = long_condition ? "LONG ðŸ”¼" : short_condition ? "SHORT ðŸ”½" : "-"
    last_color = long_condition ? color.lime : short_condition ? color.red : color.gray
    table.cell(stats_table, 1, 3, last_signal, text_color=last_color, text_size=size.small, bgcolor=color.new(color.black, 30))