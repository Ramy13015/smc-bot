//@version=5
indicator("SMC Detector - HIGH VOLUME MARKETS", shorttitle="SMC-HV", overlay=true)

// === CONFIGURATION HIGH VOLUME ===
symbol_select = input.string("BTCUSDT.P", "High Volume Symbol", options=["EURUSD", "GBPUSD", "USDJPY", "AUDUSD", "USDCAD", "XAUUSD", "BTCUSDT.P", "ETHUSDT.P", "SOLUSDT.P", "ADAUSDT.P", "DOGEUSDT.P", "XRPUSDT.P"])
htf_tf = input.timeframe("15", "Timeframe", options=["15", "60"])
webhook_url = input.string("https://smc-gal.onrender.com/tv", "Webhook URL")

// Volume filter for high-activity markets only
min_volume_mult = input.float(1.5, "Minimum Volume Multiplier", minval=1.0, maxval=5.0)

// === SYMBOL LOGIC ===
get_symbol_data() =>
    asset_type = "forex"
    if str.contains(symbol_select, ".P") or str.contains(symbol_select, "USDT")
        asset_type := "crypto"
    else if str.contains(symbol_select, "XAU")
        asset_type := "gold"
    
    [request.security(symbol_select, timeframe.period, close), asset_type]

[current_price, asset_type] = get_symbol_data()

// === HIGH VOLUME FILTER ===
volume_sma = ta.sma(volume, 20)
high_volume = volume > volume_sma * 1.0  // TEST: Lowered from 1.5x to 1.0x for more signals

// === SMC DETECTION ENHANCED ===
// ATR calculation with asset-specific adjustments
atr_length = 14
atr_value = ta.atr(atr_length)

// Volume-weighted ATR for better accuracy
vol_weighted_atr = atr_value * (volume / volume_sma)

// POI (Point of Interest) detection - Enhanced for high volume
rsi_value = ta.rsi(close, 14)
poi_valid = (ta.crossover(rsi_value, 30) or ta.crossunder(rsi_value, 70))  // TEST: Removed high_volume requirement

// FVG (Fair Value Gap) detection - More strict for perpetuals
fvg_threshold = asset_type == "crypto" ? 0.5 : 0.3  // TEST: Lowered from 0.8/0.5 to 0.5/0.3
fvg_gap = math.abs(high[1] - low[1]) > atr_value * fvg_threshold
fvg_open = fvg_gap and (close > high[1] or close < low[1])  // TEST: Removed high_volume requirement

// Order Block detection - Volume confirmation required
ob_volume_threshold = asset_type == "crypto" ? 2.0 : 1.5
ob_volume = volume > ta.sma(volume, 20) * ob_volume_threshold
ema_cross = ta.crossover(close, ta.ema(close, 20)) or ta.crossunder(close, ta.ema(close, 20))
ob_valid = ob_volume and ema_cross

// BOS (Break of Structure) - Enhanced for volatile markets
swing_length = asset_type == "crypto" ? 7 : 5
swing_high = ta.pivothigh(high, swing_length, swing_length)
swing_low = ta.pivotlow(low, swing_length, swing_length)
bos_confirm = (not na(swing_high) or not na(swing_low)) and high_volume

// CHOCH (Change of Character) - Trend reversal detection
ema_fast = ta.ema(close, 21)
ema_slow = ta.ema(close, 50)
trend_direction = ema_fast > ema_slow ? 1 : -1
choch_confirm = trend_direction != trend_direction[1] and high_volume

// Additional SMC flags for high volume markets
liq_swept = volume > ta.sma(volume, 10) * 2.5 and high_volume
imbalance_threshold = asset_type == "crypto" ? 1.2 : 0.8
imbalance_filled = math.abs(close - open) > atr_value * imbalance_threshold

// Trend alignment - Multiple timeframes
ema_200 = ta.ema(close, 200)
trend_aligned = (close > ema_fast and ema_fast > ema_slow and ema_slow > ema_200) or (close < ema_fast and ema_fast < ema_slow and ema_slow < ema_200)

volume_confirm = volume > ta.sma(volume, 20) * 1.3

// Time filter - Avoid low liquidity hours (enhanced for crypto)
is_crypto = asset_type == "crypto"
avoid_hours = is_crypto ? false : (hour >= 22 or hour <= 2)
time_filter = not avoid_hours and high_volume

// === SIGNAL GENERATION FOR HIGH VOLUME ===
// TEST MODE: Relaxed conditions to verify connection
// Original: poi_valid and fvg_open and trend_aligned and volume_confirm
long_signal_strength = (poi_valid or fvg_open) and high_volume  // Just need ONE of POI or FVG
short_signal_strength = (poi_valid or fvg_open) and high_volume

long_condition = long_signal_strength and close > ema_fast
short_condition = short_signal_strength and close < ema_fast

// === WEBHOOK PAYLOAD ===
if (long_condition or short_condition) and high_volume
    direction = long_condition ? "LONG" : "SHORT"
    event_id = str.tostring(symbol_select) + "_HV_" + str.tostring(time) + "_" + str.tostring(math.round(math.random()*10000))
    
    // Use volume-weighted ATR for crypto perpetuals
    final_atr = asset_type == "crypto" ? vol_weighted_atr : atr_value
    
    // Dynamic timeframe in payload
    tf_display = htf_tf == "15" ? "15min" : "1h"
    
    // Simplified payload construction
    payload = '{"event_id":"' + event_id + '","symbol":"' + symbol_select + '","timeframe":"' + tf_display + '","direction":"' + direction + '","price_ctx":{"entry":' + str.tostring(close) + ',"ref_high":' + str.tostring(high) + ',"ref_low":' + str.tostring(low) + '},"atr":' + str.tostring(final_atr) + ',"asset_type":"' + asset_type + '","flags":{"poi_valid":' + str.tostring(poi_valid) + ',"fvg_open":' + str.tostring(fvg_open) + ',"ob_valid":' + str.tostring(ob_valid) + ',"bos_confirm":' + str.tostring(bos_confirm) + ',"choch_confirm":' + str.tostring(choch_confirm) + ',"liq_swept":' + str.tostring(liq_swept) + ',"imbalance_filled":' + str.tostring(imbalance_filled) + ',"trend_aligned":' + str.tostring(trend_aligned) + ',"volume_confirm":' + str.tostring(volume_confirm) + ',"time_filter":' + str.tostring(time_filter) + '}}'
    
    alert(payload, alert.freq_once_per_bar)

// === VISUAL INDICATORS ===
// Enhanced visuals for high volume signals
plotshape(long_condition and high_volume, style=shape.triangleup, location=location.belowbar, 
          color=color.new(color.green, 0), size=size.large, title="HIGH VOLUME LONG")
plotshape(short_condition and high_volume, style=shape.triangledown, location=location.abovebar, 
          color=color.new(color.red, 0), size=size.large, title="HIGH VOLUME SHORT")

// Volume indicator
volume_color = high_volume ? color.orange : color.gray
plotshape(high_volume, style=shape.circle, location=location.bottom, color=volume_color, size=size.tiny)

// Display symbol info and volume status
var label info_label = na
label.delete(info_label)
volume_status = high_volume ? "HIGH VOL" : "LOW VOL"
label_color = high_volume ? color.green : color.red
info_label := label.new(bar_index, high * 1.01, symbol_select + " (" + asset_type + ") - " + volume_status, style=label.style_label_left, color=label_color, textcolor=color.white, size=size.normal)

// ATR and Volume info
var table info_table = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(info_table, 0, 0, "Symbol", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 0, symbol_select, text_color=color.blue, text_size=size.small)
    table.cell(info_table, 0, 1, "Asset Type", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 1, asset_type, text_color=color.blue, text_size=size.small)
    table.cell(info_table, 0, 2, "Volume Ratio", text_color=color.black, text_size=size.small)
    vol_ratio_color = high_volume ? color.green : color.red
    table.cell(info_table, 1, 2, str.tostring(math.round(volume/volume_sma, 2)), text_color=vol_ratio_color, text_size=size.small)
    table.cell(info_table, 0, 3, "ATR", text_color=color.black, text_size=size.small)
    atr_precision = asset_type == "forex" ? 5 : 2
    table.cell(info_table, 1, 3, str.tostring(math.round(atr_value, atr_precision)), text_color=color.purple, text_size=size.small)